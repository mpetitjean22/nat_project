package nat

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestAddMapping(t *testing.T) {
	testNat := Table{}

	testNat.AddMapping([4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x50}, [4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	assert.Equal(t, len(testNat.natTable), 1)

	testNat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x50})
	assert.Equal(t, len(testNat.natTable), 2)

	testNat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x3C})
	assert.Equal(t, len(testNat.natTable), 2)

	exp := map[IPv4Address]*IPv4Address{
		IPv4Address{
			[4]byte{0x01, 0x01, 0x01, 0x01},
			[2]byte{0x00, 0x50},
		}: &IPv4Address{
			[4]byte{0x02, 0x02, 0x02, 0x02},
			[2]byte{0x00, 0x50},
		},

		IPv4Address{
			[4]byte{0x02, 0x02, 0x02, 0x02},
			[2]byte{0x00, 0x50},
		}: &IPv4Address{
			[4]byte{0x01, 0x01, 0x01, 0x01},
			[2]byte{0x00, 0x3C},
		},
	}

	for expKey, expValue := range exp {
		value, ok := testNat.natTable[expKey]
		if !ok {
			t.Errorf("Key %v Not Found", expKey)
		}
		if expValue.ipAdress != value.ipAdress {
			t.Errorf("Incorrect Addressing Mapping. Expected %v Got %v", expValue.ipAdress, value.ipAdress)
		}
		if expValue.port != value.port {
			t.Errorf("Incorrect Port Mapping. Expected %v Got %v", expValue.port, value.port)
		}
	}
}

func TestGetMapping(t *testing.T) {
	testNat := Table{}
	testNat.AddMapping([4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x50}, [4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	testNat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x50})
	testNat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x3C}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x46})
	testNat.AddMapping([4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x32}, [4]byte{0x04, 0x04, 0x04, 0x04}, [2]byte{0x00, 0x3C})
	assert.Equal(t, len(testNat.natTable), 4)

	ip, port, err := testNat.GetMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	assert.Equal(t, nil, err)
	assert.Equal(t, [2]byte{0x00, 0x50}, port)
	assert.Equal(t, [4]byte{0x03, 0x03, 0x03, 0x03}, ip)

	ip, port, err = testNat.GetMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x3C})
	assert.Equal(t, nil, err)
	assert.Equal(t, [2]byte{0x00, 0x46}, port)
	assert.Equal(t, [4]byte{0x03, 0x03, 0x03, 0x03}, ip)

	ip, port, err = testNat.GetMapping([4]byte{0x04, 0x04, 0x04, 0x04}, [2]byte{0x00, 0x3C})
	assert.Equal(t, fmt.Errorf("Not Found"), err)
	assert.Equal(t, [2]byte{}, port)
	assert.Equal(t, [4]byte{}, ip)
}
