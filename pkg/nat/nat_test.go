package nat

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestAddMapping(t *testing.T) {
	test_nat := NAT_Table{}

	test_nat.AddMapping([4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x50}, [4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	assert.Equal(t, len(test_nat.nat_table), 1)

	test_nat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x50})
	assert.Equal(t, len(test_nat.nat_table), 2)

	test_nat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x3C})
	assert.Equal(t, len(test_nat.nat_table), 2)

	exp := map[IPAddress]*IPAddress{
		IPAddress{
			[4]byte{0x01, 0x01, 0x01, 0x01},
			[2]byte{0x00, 0x50},
		}: &IPAddress{
			[4]byte{0x02, 0x02, 0x02, 0x02},
			[2]byte{0x00, 0x50},
		},

		IPAddress{
			[4]byte{0x02, 0x02, 0x02, 0x02},
			[2]byte{0x00, 0x50},
		}: &IPAddress{
			[4]byte{0x01, 0x01, 0x01, 0x01},
			[2]byte{0x00, 0x3C},
		},
	}

	for expKey, expValue := range exp {
		value, ok := test_nat.nat_table[expKey]
		if !ok {
			t.Errorf("Key %v Not Found", expKey)
		}
		if expValue.ipAdress != value.ipAdress {
			t.Errorf("Incorrect Addressing Mapping. Expected %v Got %v", expValue.ipAdress, value.ipAdress)
		}
		if expValue.port != value.port {
			t.Errorf("Incorrect Port Mapping. Expected %v Got %v", expValue.port, value.port)
		}
	}
}

func TestGetMapping(t *testing.T) {
	test_nat := NAT_Table{}
	test_nat.AddMapping([4]byte{0x01, 0x01, 0x01, 0x01}, [2]byte{0x00, 0x50}, [4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	test_nat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x50})
	test_nat.AddMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x3C}, [4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x46})
	test_nat.AddMapping([4]byte{0x03, 0x03, 0x03, 0x03}, [2]byte{0x00, 0x32}, [4]byte{0x04, 0x04, 0x04, 0x04}, [2]byte{0x00, 0x3C})
	assert.Equal(t, len(test_nat.nat_table), 4)

	ip, port, err := test_nat.GetMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x50})
	assert.Equal(t, nil, err)
	assert.Equal(t, [2]byte{0x00, 0x50}, port)
	assert.Equal(t, [4]byte{0x03, 0x03, 0x03, 0x03}, ip)

	ip, port, err = test_nat.GetMapping([4]byte{0x02, 0x02, 0x02, 0x02}, [2]byte{0x00, 0x3C})
	assert.Equal(t, nil, err)
	assert.Equal(t, [2]byte{0x00, 0x46}, port)
	assert.Equal(t, [4]byte{0x03, 0x03, 0x03, 0x03}, ip)

	ip, port, err = test_nat.GetMapping([4]byte{0x04, 0x04, 0x04, 0x04}, [2]byte{0x00, 0x3C})
	assert.Equal(t, fmt.Errorf("Not Found"), err)
	assert.Equal(t, [2]byte{}, port)
	assert.Equal(t, [4]byte{}, ip)
}
